generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider          = "mysql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model user_rank_history {
  id      Int      @id @default(autoincrement())
  user_id Int
  mode    Int      @db.TinyInt
  pp      Int      @default(0) @db.UnsignedInt
  rank    Int      @default(0) @db.UnsignedInt
  date    DateTime @db.Date
  user    users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, mode, date])
  @@index([user_id])
  @@index([date])
}

model verification_codes {
  id         Int      @id @default(autoincrement())
  osu_id     Int
  discord_id String   @db.VarChar(30)
  code       String   @db.VarChar(10)
  created_at DateTime @default(now())
  user       users    @relation(fields: [osu_id], references: [id], onDelete: Cascade)

  @@index([osu_id])
}

model api_keys {
  id         Int      @id @default(autoincrement())
  name       String   @db.VarChar(50)
  key        String   @unique @db.Char(64)
  owner_id   Int
  created_at DateTime @default(now())
  can_write  Boolean  @default(false)
  user       users    @relation(fields: [owner_id], references: [id], onDelete: Cascade)

  @@index([owner_id])
}

model invites {
  id            Int      @id @default(autoincrement())
  code          String   @unique @db.VarChar(64)
  expires_at    DateTime
  created_at    DateTime @default(now())
  created_by_id Int
  used_by_id    Int?     @unique
  creator       users    @relation("CreatedInvites", fields: [created_by_id], references: [id], onDelete: Cascade)
  used_by       users?   @relation("UsedInvites", fields: [used_by_id], references: [id], onDelete: Cascade)

  @@index([created_by_id])
  @@index([used_by_id])
}

model users {
  id                 Int      @id @default(autoincrement())
  name               String   @unique @db.VarChar(32)
  safe_name          String   @unique @db.VarChar(32)
  email              String   @unique @db.VarChar(254)
  priv               Int      @default(1)
  pw_bcrypt          String   @db.Char(60)
  country            String   @default("xx") @db.Char(2)
  silence_end        Int      @default(0)
  donor_end          Int      @default(0)
  creation_time      Int      @default(0)
  latest_activity    Int      @default(0)
  clan_id            Int      @default(0)
  clan_priv          Int      @default(0) @db.TinyInt
  preferred_mode     Int      @default(0)
  play_style         Int      @default(0)
  custom_badge_name  String?  @db.VarChar(16)
  custom_badge_icon  String?  @db.VarChar(64)
  userpage_content   String?  @db.VarChar(2048)
  api_key            String?  @unique @db.Char(36)
  is_dev             Boolean  @default(false)
  is_admin           Boolean  @default(false)
  discord_id         String?  @unique
  stats              stats[]
  scores             scores[]
  created_invites    invites[] @relation("CreatedInvites")
  used_invites       invites[] @relation("UsedInvites")
  fubika_api_keys    api_keys[]
  verification_codes verification_codes[]
  rank_history       user_rank_history[]
  comments           comments[]
  sent_mail          mail[]    @relation("SentMail")
  received_mail      mail[]    @relation("ReceivedMail")
  logs_from          logs[]    @relation("LogsFrom")
  logs_to            logs[]    @relation("LogsTo")
  user_achievements  user_achievements[]
  client_hashes      client_hashes[]
  relationships_from relationships[] @relation("RelationshipsFrom")
  relationships_to   relationships[] @relation("RelationshipsTo")

  @@index([priv])
  @@index([clan_id])
  @@index([clan_priv])
  @@index([country])
}

model stats {
  id           Int
  mode         Int    @db.TinyInt
  tscore       BigInt @default(0) @db.UnsignedBigInt
  rscore       BigInt @default(0) @db.UnsignedBigInt
  pp           Int    @default(0) @db.UnsignedInt
  plays        Int    @default(0) @db.UnsignedInt
  playtime     Int    @default(0) @db.UnsignedInt
  acc          Float  @default(0.000) @db.Float
  max_combo    Int    @default(0) @db.UnsignedInt
  total_hits   Int    @default(0) @db.UnsignedInt
  replay_views Int    @default(0) @db.UnsignedInt
  xh_count     Int    @default(0) @db.UnsignedInt
  x_count      Int    @default(0) @db.UnsignedInt
  sh_count     Int    @default(0) @db.UnsignedInt
  s_count      Int    @default(0) @db.UnsignedInt
  a_count      Int    @default(0) @db.UnsignedInt
  user         users  @relation(fields: [id], references: [id], onDelete: Cascade)

  @@id([id, mode])
  @@index([mode])
  @@index([pp])
  @@index([tscore])
  @@index([rscore])
}

model scores {
  id              BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  map_md5         String   @db.Char(32)
  score           Int
  pp              Float    @db.Float
  acc             Float    @db.Float
  max_combo       Int
  mods            Int
  n300            Int
  n100            Int
  n50             Int
  nmiss           Int
  ngeki           Int
  nkatu           Int
  grade           String   @default("N") @db.VarChar(2)
  status          Int      @db.TinyInt
  mode            Int      @db.TinyInt
  play_time       DateTime @db.DateTime(0)
  time_elapsed    Int
  client_flags    Int
  userid          Int
  perfect         Boolean
  online_checksum String   @db.Char(32)
  user            users    @relation(fields: [userid], references: [id], onDelete: Cascade)
  performance_reports performance_reports[]

  score_sr        Float    @default(0.000) @db.Float

  @@index([map_md5, status, mode])
  @@index([map_md5])
  @@index([mode])
  @@index([mods])
  @@index([online_checksum])
  @@index([play_time])
  @@index([pp])
  @@index([score])
  @@index([status])
  @@index([userid])
}

model client_hashes {
  userid       Int
  osupath      String   @db.Char(32)
  adapters     String   @db.Char(32)
  uninstall_id String   @db.Char(32)
  disk_serial  String   @db.Char(32)
  latest_time  DateTime @db.DateTime(0)
  occurrences  Int      @default(0)
  user         users    @relation(fields: [userid], references: [id], onDelete: Cascade)

  @@id([userid, osupath, adapters, uninstall_id, disk_serial])
  @@index([userid])
}

model achievements {
  id                Int                @id @default(autoincrement())
  file              String             @unique @db.VarChar(128)
  name              String             @unique @db.VarChar(128)
  desc              String             @unique @db.VarChar(256)
  cond              String             @db.VarChar(64)
  user_achievements user_achievements[]
}

model user_achievements {
  userid      Int
  achid       Int
  user        users        @relation(fields: [userid], references: [id], onDelete: Cascade)
  achievement achievements @relation(fields: [achid], references: [id], onDelete: Cascade)

  @@id([userid, achid])
  @@index([achid])
  @@index([userid])
}

model channels {
  id         Int     @id @default(autoincrement())
  name       String  @unique @db.VarChar(32)
  topic      String  @db.VarChar(256)
  read_priv  Int     @default(1)
  write_priv Int     @default(2)
  auto_join  Boolean @default(false)

  @@index([auto_join])
}

model clans {
  id         Int      @id @default(autoincrement())
  name       String   @unique @db.VarChar(16)
  tag        String   @unique @db.VarChar(6)
  owner      Int      @unique
  created_at DateTime @db.DateTime(0)
}

model maps {
  server       maps_server @default(osu_)
  id           Int         @unique
  set_id       Int
  status       Int
  md5          String      @unique @db.Char(32)
  artist       String      @db.VarChar(128)
  title        String      @db.VarChar(128)
  version      String      @db.VarChar(128)
  creator      String      @db.VarChar(19)
  filename     String      @db.VarChar(256)
  last_update  DateTime    @db.DateTime(0)
  total_length Int
  max_combo    Int
  frozen       Boolean     @default(false)
  plays        Int         @default(0)
  passes       Int         @default(0)
  mode         Int         @default(0) @db.TinyInt
  bpm          Float       @default(0.00) @db.Float
  cs           Float       @default(0.00) @db.Float
  ar           Float       @default(0.00) @db.Float
  od           Float       @default(0.00) @db.Float
  hp           Float       @default(0.00) @db.Float
  diff         Float       @default(0.000) @db.Float

  @@id([server, id])
  @@index([set_id])
  @@index([status])
  @@index([filename])
  @@index([plays])
  @@index([mode])
  @@index([frozen])
}

model mapsets {
  server            mapsets_server @default(osu_)
  id                Int            @unique
  last_osuapi_check DateTime       @default(now()) @db.DateTime(0)

  @@id([server, id])
}

model map_requests {
  id        Int      @id @default(autoincrement())
  map_id    Int
  player_id Int
  datetime  DateTime @db.DateTime(0)
  active    Boolean
}

model comments {
  id          Int                  @id @default(autoincrement())
  target_id   Int
  target_type comments_target_type
  userid      Int
  time        Int
  comment     String               @db.VarChar(80)
  colour      String?              @db.Char(6)
  user        users                @relation(fields: [userid], references: [id], onDelete: Cascade)

  @@index([userid])
  @@index([target_id])
}

model favourites {
  userid     Int
  setid      Int
  created_at Int @default(0)

  @@id([userid, setid])
}

model ingame_logins {
  id         Int      @id @default(autoincrement())
  userid     Int
  ip         String   @db.VarChar(45)
  osu_ver    DateTime @db.Date
  osu_stream String   @db.VarChar(11)
  datetime   DateTime @db.DateTime(0)
}

model relationships {
  user1      Int
  user2      Int
  type       relationships_type
  user_from  users @relation("RelationshipsFrom", fields: [user1], references: [id], onDelete: Cascade)
  user_to    users @relation("RelationshipsTo", fields: [user2], references: [id], onDelete: Cascade)

  @@id([user1, user2])
  @@index([user1])
  @@index([user2])
}

model logs {
  id         Int      @id @default(autoincrement())
  from       Int
  to         Int
  action     String   @db.VarChar(32)
  msg        String?  @db.VarChar(2048)
  time       DateTime @default(now()) @db.DateTime(0)
  from_user  users    @relation("LogsFrom", fields: [from], references: [id], onDelete: Cascade)
  to_user    users    @relation("LogsTo", fields: [to], references: [id], onDelete: Cascade)

  @@index([from])
  @@index([to])
}

model mail {
  id       Int     @id @default(autoincrement())
  from_id  Int
  to_id    Int
  msg      String  @db.VarChar(2048)
  time     Int?
  read     Boolean @default(false)
  sender   users   @relation("SentMail", fields: [from_id], references: [id], onDelete: Cascade)
  receiver users   @relation("ReceivedMail", fields: [to_id], references: [id], onDelete: Cascade)

  @@index([from_id])
  @@index([to_id])
}

model ratings {
  userid  Int
  map_md5 String @db.Char(32)
  rating  Int    @db.TinyInt

  @@id([userid, map_md5])
}

model performance_reports {
  scoreid           BigInt                       @db.UnsignedBigInt
  mod_mode          performance_reports_mod_mode @default(vanilla)
  os                String                       @db.VarChar(64)
  fullscreen        Boolean
  fps_cap           String                       @db.VarChar(16)
  compatibility     Boolean
  version           String                       @db.VarChar(16)
  start_time        Int
  end_time          Int
  frame_count       Int
  spike_frames      Int
  aim_rate          Int
  completion        Boolean
  identifier        String?                      @db.VarChar(128)
  average_frametime Int
  score             scores                       @relation(fields: [scoreid], references: [id], onDelete: Cascade)

  @@id([scoreid, mod_mode])
  @@index([scoreid])
}

model startups {
  id        Int      @id @default(autoincrement())
  ver_major Int      @db.TinyInt
  ver_minor Int      @db.TinyInt
  ver_micro Int      @db.TinyInt
  datetime  DateTime @db.DateTime(0)
}

model tourney_pool_maps {
  map_id  Int
  pool_id Int
  mods    Int
  slot    Int @db.TinyInt

  @@id([map_id, pool_id])
}

model tourney_pools {
  id         Int      @id @default(autoincrement())
  name       String   @db.VarChar(16)
  created_at DateTime @db.DateTime(0)
  created_by Int

  @@index([created_by])
}

enum maps_server {
  osu_    @map("osu!")
  private
}

enum mapsets_server {
  osu_    @map("osu!")
  private
}

enum performance_reports_mod_mode {
  vanilla
  relax
  autopilot
}

enum comments_target_type {
  replay
  map
  song
}

enum relationships_type {
  friend
  block
}